# Use a modern Node image as the base
FROM node:22-bullseye

# Install basic development tools
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    curl \
    python3 \
    python3-pip \
    vim \
    bash \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install the Gemini and Claude CLIs globally
# We use ADD to fetch the latest version info from NPM, which busts the cache only when a new version is released
ADD https://registry.npmjs.org/@google/gemini-cli/latest /tmp/gemini-version.json
ADD https://registry.npmjs.org/@anthropic-ai/claude-code/latest /tmp/claude-version.json
RUN npm install -g @google/gemini-cli @anthropic-ai/claude-code --unsafe-perm

# Pre-configure Gemini CLI settings
RUN mkdir -p /root/.gemini && \
    echo '{"general": {"previewFeatures": true}, "security": {"auth": {"selectedType": "oauth-personal"}}}' > /root/.gemini/settings.json

# Set up a working directory
WORKDIR /workspace

# Copy and setup initialization script
COPY init_sprite.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/init_sprite.sh

# Entrypoint handles identity setup
ENTRYPOINT ["/usr/local/bin/init_sprite.sh"]

# Default command: keep the container running
CMD ["tail", "-f", "/dev/null"]
